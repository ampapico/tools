<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆPDFå–è¾¼ + å€™è£œç”»åƒä»˜ãï¼‰</title>
<script src="qrc:///qtwebchannel/qwebchannel.js"></script>
<style>
  body { font-family: "Segoe UI", sans-serif; margin: 30px; }
  h1 { margin-bottom: 10px; }
  table { border-collapse: collapse; width: 100%; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f4f4f4; }
  input { width: 95%; padding: 5px; font-size: 13px; }
  button { margin-top: 20px; padding: 10px 25px; font-size: 15px; cursor: pointer; }
  #candidateDialog {
    display:none; position:fixed; top:50%; left:50%;
    transform:translate(-50%,-50%); background:white;
    border:2px solid #333; padding:20px; border-radius:8px;
    box-shadow:0 0 20px rgba(0,0,0,0.3);
    width:900px; height:700px; overflow:auto;
  }
  .img-wrap { position:relative; margin:10px; }
  .img-wrap img { max-width:800px; border:1px solid #aaa; cursor:pointer; }
  .img-wrap p { margin:5px 0; }
</style>
</head>
<body>

<h1>ğŸ“„ å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆPDFå–è¾¼ + å€™è£œç”»åƒä»˜ãï¼‰</h1>

<!-- PDFé¸æŠ -->
<label>PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠï¼š</label>
<input type="file" id="pdfInput" accept="application/pdf" onchange="handlePdfSelect(event)" />
<br><br>

<!-- è‡ªå‹•å½¢å¼å -->
<label>å½¢å¼åï¼ˆè‡ªå‹•è¨­å®šï¼‰</label>
<input type="text" id="formName" readonly style="width:300px; padding:5px;" placeholder="PDFã‚’é¸æŠã—ã¦ãã ã•ã„" />

<!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
<table>
  <thead>
    <tr><th>#</th><th>Textï¼ˆå…±é€šé …ç›®åï¼‰</th><th>Keywordï¼ˆå°å­—åï¼‰</th><th>Valueï¼ˆOCRå€¤ï¼‰</th></tr>
  </thead>
  <tbody id="items"></tbody>
</table>

<button onclick="startProcess()">â–¶ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

<div id="status"></div>

<!-- å€™è£œç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="candidateDialog">
  <h3>å€™è£œãŒè¤‡æ•°è¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ç•ªå·å…¥åŠ›ã§é¸æŠï¼‰</h3>
  <div id="candidateList"></div>
  <br>
  <input type="number" id="selectId" placeholder="ç•ªå·å…¥åŠ›ã§é¸æŠ" />
  <button onclick="selectByNumber()">ç•ªå·ã§é¸æŠ</button>
  <button onclick="closeDialog()">é–‰ã˜ã‚‹</button>
</div>

<script>
let bridge = null;
new QWebChannel(qt.webChannelTransport, channel => {
  bridge = channel.objects.bridge;
});

// å›ºå®šTextä¸€è¦§
const FIXED_ITEMS = [
  "æ°å","ç”Ÿå¹´æœˆæ—¥","æ€§åˆ¥","èº«é•·","ä½“é‡",
  "BMI","è¡€åœ§ï¼ˆæœ€é«˜ï¼‰","è¡€åœ§ï¼ˆæœ€ä½ï¼‰","è¦–åŠ›ï¼ˆå³ï¼‰","è¦–åŠ›ï¼ˆå·¦ï¼‰"
];

// ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
const tbody = document.getElementById("items");
FIXED_ITEMS.forEach((text, idx) => {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${idx + 1}</td>
    <td>${text}</td>
    <td><input type="text" class="keyword" placeholder="ä¾‹ï¼šèº«é•·(cm)" /></td>
    <td><input type="text" class="value" placeholder="ä¾‹ï¼š162.5" /></td>
  `;
  tbody.appendChild(tr);
});

// === PDFãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç† ===
function handlePdfSelect(event) {
  const file = event.target.files[0];
  if (!file) return;
  const fileName = file.name.replace(/\.[^/.]+$/, ""); // æ‹¡å¼µå­é™¤å»
  document.getElementById("formName").value = fileName;
  document.getElementById("status").textContent = `ğŸ“ ${file.name} ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
}

// === Pythonå‡¦ç†å®Ÿè¡Œ ===
function startProcess() {
  if (!bridge) return alert("Bridgeæœªæ¥ç¶šã§ã™");
  const formName = document.getElementById("formName").value.trim();
  if (!formName) return alert("PDFã‚’å…ˆã«é¸æŠã—ã¦ãã ã•ã„");

  const rows = [...document.querySelectorAll("#items tr")];
  const data = rows.map(r => ({
    text: r.cells[1].innerText,
    keyword: r.querySelector(".keyword").value.trim(),
    value: r.querySelector(".value").value.trim()
  }));

  document.getElementById("status").textContent = "ğŸ“¡ Pythonå‡¦ç†ä¸­...";
  bridge.processKeyword(JSON.stringify(data)).then(res => {
    const candidates = JSON.parse(res);
    showCandidates(candidates);
    document.getElementById("status").textContent = "âœ… å€™è£œã‚’è¡¨ç¤ºä¸­";
  });
}

// === å€™è£œç”»åƒè¡¨ç¤º ===
function showCandidates(candidates) {
  const list = document.getElementById("candidateList");
  list.innerHTML = "";

  candidates.forEach((c, i) => {
    const div = document.createElement("div");
    div.className = "img-wrap";
    div.innerHTML = `
      <p><b>${c.keyword}</b>ï¼ˆå€™è£œ ${i+1}ï¼‰</p>
      <img src="${c.image}" onclick="selectCandidate(${i})" />
      <p>é ˜åŸŸID: ${c.bboxes.map(b => b.id).join(", ")}</p>
    `;
    list.appendChild(div);
  });

  document.getElementById("candidateDialog").style.display = "block";
}

// === å€™è£œé¸æŠ ===
function selectCandidate(index) {
  alert(`å€™è£œ ${index + 1} ã‚’é¸æŠã—ã¾ã—ãŸï¼`);
  closeDialog();
}

function selectByNumber() {
  const id = parseInt(document.getElementById("selectId").value);
  if (!id) return alert("ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  alert(`å€™è£œç•ªå· ${id} ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`);
  closeDialog();
}

function closeDialog() {
  document.getElementById("candidateDialog").style.display = "none";
}
</script>

</body>
</html>
